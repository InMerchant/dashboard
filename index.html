<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사고 데이터 시각화</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        /* 지도 스타일 */
        path {
            stroke: white;
            stroke-width: 0.5;
            fill: #dcdcdc; /* 기본 색상: 연한 회색 */
        }
    </style>
</head>
<body>
    <!-- 연도 선택 드롭다운 -->
    <select id="yearSelect" onchange="loadBaseData()">
        <option value="2020">2020</option>
        <option value="2021">2021</option>
        <option value="2022">2022</option>
    </select>

    <!-- 카테고리 선택 드롭다운 (초기에 숨김) -->
    <select id="categorySelect" onchange="updateVisualization()" style="display: none;">
        <option value="부위별">부위별</option>
        <option value="사고당시활동">사고당시활동</option>
        <option value="시간별">시간별</option>
        <option value="장소별">장소별</option>
        <option value="형태별">형태별</option>
    </select>

    <!-- 지도를 그릴 SVG 영역 -->
    <svg width="800" height="600" id="map"></svg>

    <script>
        const svg = d3.select("#map");
        let baseData = null; // 연도별 기본 데이터 저장 변수
        let categoryData = null; // 카테고리별 데이터 저장 변수

        // 대한민국 지도 데이터 로드
        d3.json("TL_SCCO_CTPRVN.json").then(data => {
            const projection = d3.geoMercator().fitSize([800, 600], data);
            const path = d3.geoPath().projection(projection);

            svg.selectAll("path")
                .data(data.features)
                .enter().append("path")
                .attr("d", path)
                // 지도의 각 지역에 마우스 이벤트 핸들러 설정
                .on("mouseover", handleMouseOver) // 마우스 오버 이벤트
                .on("mouseout", handleMouseOut)   // 마우스 아웃 이벤트
                .on("click", handleRegionClick);  // 지역 클릭 이벤트
        });

        // 마우스 오버 이벤트 핸들러
        function handleMouseOver(d) {
        d3.select(this).style("stroke-width", "3");
        }

        // 마우스 아웃 이벤트 핸들러
        function handleMouseOut(d) {
        d3.select(this).style("stroke-width", "0.5");
        }

        // 지역 클릭 이벤트 핸들러
        function handleRegionClick(d) {
            const selectedRegion = d.properties.CTP_KOR_NM;
            console.log(`선택된 지역: ${selectedRegion}`);
            document.getElementById("categorySelect").style.display = "inline"; // 카테고리 선택 드롭다운 표시
        }

        // 색상 척도 설정 (보간 함수를 사용하여 세분화)
        const colorScale = d3.scaleSequential(d3.interpolateReds);

        // 지역명 매핑
        const regionMapping = {
            "서울특별시": "서울",
            "부산광역시": "부산",
            "대구광역시": "대구",
            "인천광역시": "인천",
            "광주광역시": "광주",
            "대전광역시": "대전",
            "울산광역시": "울산",
            "세종특별자치시": "세종",
            "경기도": "경기",
            "강원도": "강원",
            "충청북도": "충북",
            "충청남도": "충남",
            "전라북도": "전북",
            "전라남도": "전남",
            "경상북도": "경북",
            "경상남도": "경남",
            "제주특별자치도": "제주"
        };

        // 연도 변경 시 기본 데이터 로드 함수
        function loadBaseData() {
            const selectedYear = document.getElementById("yearSelect").value || "2020"; // 기본 연도 설정
            const baseCsvFilePath = `${selectedYear}/${selectedYear}사고발생데이터_수정.csv`;

            d3.csv(baseCsvFilePath).then(data => {
                // 지역별 사고 발생 빈도 집계
                const regionCounts = {};
                let totalCount = 0; // 전체 발생 건수

                data.forEach(d => {
                    const region = d.지역;
                    if (!regionCounts[region]) {
                        regionCounts[region] = 0;
                    }
                    regionCounts[region]++;
                    totalCount++;
                });

                // 지역별 발생 건수의 비율 계산
                const regionRatios = {};
                for (const region in regionCounts) {
                    regionRatios[region] = regionCounts[region] / totalCount;
                }

                // 색상 척도의 도메인 설정
                const maxRatio = Math.max(...Object.values(regionRatios));
                colorScale.domain([0, maxRatio]);

                // 지도의 색상 업데이트
                svg.selectAll("path")
                    .style("fill", d => {
                        const regionName = d.properties.CTP_KOR_NM;
                        const mappedRegion = regionMapping[regionName];
                        const ratio = regionRatios[mappedRegion] || 0;
                        //console.log(`지역: ${mappedRegion}, 발생 비율: ${ratio}`); // 콘솔에 지역별 사고 발생 비율 출력
                        return colorScale(ratio); // 해당 지역의 사고 발생 비율에 따른 색상
                    });
            });
        }

        // 초기 데이터 로드
        loadBaseData();

        // 카테고리 변경 시 시각화 업데이트 함수
        function updateVisualization() {
            const selectedYear = document.getElementById("yearSelect").value;
            const selectedCategory = document.getElementById("categorySelect").value;
            const categoryCsvFilePath = `${selectedYear}/${selectedCategory}_${selectedYear}년 학교안전사고 사고발생 현황.csv`;
        }

    </script>
</body>
</html>
