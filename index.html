<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사고 데이터 시각화</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        /* 지도 스타일 */
        path {
            stroke: white;
        }
        /* 툴팁 스타일*/
        .tooltip {
            position: absolute;
            z-index: 10;
            visibility: hidden;
            background: #ffffff;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
            pointer-events: none;  /* 툴팁 위에서 마우스 이벤트를 무시 */
        }
        #yearSelect {
            top: 10px;
            left: 10px;
            z-index: 10; /*지도 위에 표시*/
        }
        #map, #barGraph, #pieChart {
            display: inline-block; /* 옆으로 배열 */
            vertical-align: top; /* 상단 정렬 */
        }
        #visualizationContainer {
            margin-top: 40px; /* 드롭다운 아래에 위치하도록 여백 설정 */
        }
    </style>
</head>
<body>
    <!-- 연도 선택 드롭다운 -->
    <select id="yearSelect" onchange="loadBaseData()">
        <option value="선택">선택</option>
        <option value="2020">2020</option>
        <option value="2021">2021</option>
        <option value="2022">2022</option>
    </select>

    <div id="visualizationContainer">
        <!-- 지도를 그릴 SVG 영역 -->
        <svg width="800" height="600" id="map"></svg>
    
        <!-- 막대 그래프를 그릴 SVG 영역 -->
        <svg width="400" height="400" id="barGraph"></svg>
    
        <!-- 원형 그래프를 그릴 SVG 영역 -->
        <svg width="400" height="400" id="pieChart"></svg>
    </div>

    <script>
        // 툴팁 추가
        const tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("position", "absolute")
        .style("z-index", "10")
        .style("visibility", "hidden")
        .style("background", "#FFFFFF")
        .style("padding", "8px")
        .style("border-radius", "6px")
        .style("border", "1px solid #ccc");

        const svg = d3.select("#map");

        let baseData = null; // 연도별 기본 데이터 저장 변수
        let categoryData = null; // 카테고리별 데이터 저장 변수

        // 대한민국 지도 데이터 로드
        d3.json("TL_SCCO_CTPRVN.json").then(data => {
            const projection = d3.geoMercator().fitSize([800, 600], data);
            const path = d3.geoPath().projection(projection);

            svg.selectAll("path")
                .data(data.features)
                .enter().append("path")
                .attr("d", path)
                // 지도의 각 지역에 마우스 이벤트 핸들러 설정
                .on("mouseover", handleMouseOver) // 마우스 오버 이벤트
                .on("mouseout", handleMouseOut)   // 마우스 아웃 이벤트
                .on("click", handleRegionClick)  // 지역 클릭 이벤트
                .on("mousemove", function() {
                    return tooltip.style("top", (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");
                });
        });

        // 마우스 오버 이벤트 핸들러
        function handleMouseOver(d) {
            const selectedYear = document.getElementById("yearSelect").value;
            if (selectedYear === "선택") {
                return; // 연도가 선택되지 않았으면 함수를 종료
            }
        
            d3.select(this).style("stroke-width", "3");
            const regionCount = baseData.filter(data => data.지역 === regionMapping[d.properties.CTP_KOR_NM]).length;
            tooltip.text(`${d.properties.CTP_KOR_NM}: ${regionCount}명`);
            return tooltip.style("visibility", "visible");
        }

        // 마우스 아웃 이벤트 핸들러
        function handleMouseOut(d) {
            d3.select(this).style("stroke-width", "0.5");
            return tooltip.style("visibility", "hidden");
        }

        // 지역 클릭 이벤트 핸들러
        function handleRegionClick(d) {
            const selectedRegion = d.properties.CTP_KOR_NM;
            //console.log(`선택된 지역: ${selectedRegion}`);
        }

        // 색상 척도 설정 (보간 함수를 사용하여 세분화)
        const colorScale = d3.scaleSequential(d3.interpolateReds);

        const pieChartSvg = d3.select("#pieChart");

        // 지역명 매핑
        const regionMapping = {
            "서울특별시": "서울",
            "부산광역시": "부산",
            "대구광역시": "대구",
            "인천광역시": "인천",
            "광주광역시": "광주",
            "대전광역시": "대전",
            "울산광역시": "울산",
            "세종특별자치시": "세종",
            "경기도": "경기",
            "강원도": "강원",
            "충청북도": "충북",
            "충청남도": "충남",
            "전라북도": "전북",
            "전라남도": "전남",
            "경상북도": "경북",
            "경상남도": "경남",
            "제주특별자치도": "제주"
        };

        // 초기 상태로 리셋하는 함수
        function resetToInitialState() {
            // 모든 지역의 색상을 초기 색상으로 재설정
            svg.selectAll("path")
            .style("fill", "#dcdcdc"); 

            // 카테고리 선택 드롭다운 숨기기
            document.getElementById("categorySelect").style.display = "none";

            //차트 숨기기
            pieChartSvg.selectAll('*').remove();
        }

        // 연도 변경 시 기본 데이터 로드 함수
        function loadBaseData() {
            const selectedYear = document.getElementById("yearSelect").value;
            
            if (selectedYear === "선택") {
                resetToInitialState(); // 초기 상태로 리셋
                return;
            }
            //파일 읽어오기
            const baseCsvFilePath = `${selectedYear}/${selectedYear}사고발생데이터_수정.csv`;   

            d3.csv(baseCsvFilePath).then(data => {
                baseData = data;
                // 지역별 사고 발생 빈도 집계
                const regionCounts = {};
                let totalCount = 0; // 전체 발생 건수

                data.forEach(d => {
                    const region = d.지역;
                    if (!regionCounts[region]) {
                        regionCounts[region] = 0;
                    }
                    regionCounts[region]++;
                    totalCount++;
                });

                // 지역별 발생 건수의 비율 계산
                const regionRatios = {};
                for (const region in regionCounts) {
                    regionRatios[region] = regionCounts[region] / totalCount;
                }

                // 색상 척도의 도메인 설정
                const maxRatio = Math.max(...Object.values(regionRatios));
                colorScale.domain([0, maxRatio]);

                // 지도의 색상 업데이트
                svg.selectAll("path")
                    .style("fill", d => {
                        const regionName = d.properties.CTP_KOR_NM;
                        const mappedRegion = regionMapping[regionName];
                        const ratio = regionRatios[mappedRegion] || 0;
                        //console.log(`지역: ${mappedRegion}, 발생 비율: ${ratio}`); // 콘솔에 지역별 사고 발생 비율 출력
                        return colorScale(ratio); // 해당 지역의 사고 발생 비율에 따른 색상
                    });
            });
        }

        // 초기 데이터 로드
        loadBaseData();

        // 지역 클릭 이벤트 핸들러
        function handleRegionClick(d) {
            const selectedRegion = d.properties.CTP_KOR_NM;

            //console.log(`선택된 지역: ${selectedRegion}`);

            document.getElementById("categorySelect").style.display = "inline"; // 카테고리 선택 드롭다운 표시

            // 해당 지역의 데이터 필터링
            const regionData = baseData.filter(data => data.지역 === regionMapping[selectedRegion]);

            // 남여 비율 계산
            const genderCounts = { 남: 0, 여: 0 };
            regionData.forEach(data => {
                const gender = data.사고자성별;
                genderCounts[gender]++;
            });
            
            //console.log(genderCounts); // 남여 카운트 결과를 콘솔에 출력

            // 원형 그래프 업데이트
            drawPieChart(genderCounts);
        }

        // 원형 차트를 그리는 함수
        function drawPieChart(genderCounts) {
            pieChartSvg.selectAll('*').remove();  // 이전 차트를 삭제

            const pieData = [
                { gender: '남', count: genderCounts.남 },
                { gender: '여', count: genderCounts.여 }
            ];

            const pie = d3.pie().value(d => d.count);
            const arc = d3.arc().innerRadius(0).outerRadius(150);

            const g = pieChartSvg.append("g")
                .attr("transform", "translate(200, 200)");

            g.selectAll("path")
                .data(pie(pieData))
                .enter().append("path")
                .attr("d", arc)
                .attr("fill", d => d.data.gender === '남' ? "#4E79A7" : "#F28E2B")  // 남: 파란색, 여: 주황색
                .attr("stroke", "white")
                .attr("stroke-width", "2px");

            // 범례 추가
            const legend = pieChartSvg.append("g")
                .attr("transform", "translate(150, 0)")
                .selectAll(".legend")
                .data(pieData)
                .enter().append("g")
                .attr("class", "legend")
                .attr("transform", (d, i) => `translate(0,${i * 20})`);

            legend.append("rect")
                .attr("x", -18)
                .attr("width", 18)
                .attr("height", 18)
                .attr("fill", d => d.gender === '남' ? "#4E79A7" : "#F28E2B");

            legend.append("text")
                .attr("x", -24)
                .attr("y", 9)
                .attr("dy", ".35em")
                .style("text-anchor", "end")
                .text(d => d.gender);
        }

    </script>
</body>
</html>
